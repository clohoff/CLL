---
title: "Processing the STAR+HTseq counted RNAseq"
author: "Junyan Lu"
date: "`r doc_date()`"
output:
  BiocStyle::html_document:
    toc_float: true
---

# Load libraries

Libraries
```{r, message=FALSE, warning=FALSE}
library(DESeq2)
library(EnsDb.Hsapiens.v86)
library(RColorBrewer)
library(pheatmap)
library(geneplotter)
library(tidyverse)
```

Global variables
```{r}
#set the global ggplot theme
theme_set(theme_bw() + theme(axis.text = element_text(size=12), 
                             axis.title = element_text(size=14),
                             plot.title = element_text(size = 15, hjust =0.5, face="bold")))
```

# Read htseq results
```{r}
rawFolder = "../../data/drugSeq/htseq/"
fileTab <- tibble(filePath = list.files(rawFolder, full.names = TRUE, recursive = TRUE)) %>%
                    mutate(fileName = basename(filePath)) %>%
                    mutate(fileName = str_remove(fileName,"Aligned_counts.out")) %>% 
  arrange(fileName) %>% mutate(id = paste0("smp",seq(nrow(.))))

countTab <- lapply(seq(nrow(fileTab)), function(i) {
  rec <- fileTab[i,]
  eachTab <- read_delim(rec$filePath, col_names = FALSE, col_types = "ci") %>%
    mutate(id = rec$id)
}) %>% bind_rows() %>%
  pivot_wider(names_from = id, values_from = X2)


countMat <- filter(countTab, !str_detect(X1,"__")) %>%
  data.frame() %>% column_to_rownames("X1") %>%
  as.matrix()

ummapedTab <- filter(countTab, str_detect(X1, "__")) %>%
  pivot_longer(-X1, names_to = "id", values_to = "count") %>%
  mutate(X1 = str_remove_all(X1,"__")) %>%
  dplyr::rename(feature = X1)
```

# Annotate samples
```{r}
load("../../var/patmeta_210324.RData")
patAnno <- readxl::read_xlsx("../../data/drugSeq/RNAseq_samples_all.xlsx") %>%
  mutate(fileName = str_replace(fileName, ".txt.gz","")) %>%
  mutate(Replicate = as.factor(Replicate)) %>%
  select(-sequence) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(diagnosis = patMeta[match(patID, patMeta$Patient.ID),]$diagnosis)

#check all samples have annotations
all(fileTab$fileName %in% patAnno$fileName)
all(patAnno$fileName %in% fileTab$fileName)

patAnno <- patAnno %>%
  left_join(fileTab, by = "fileName") %>% select(-filePath,-fileName) %>%
  data.frame() %>% column_to_rownames("id")
patAnno <- patAnno[colnames(countMat),]
```


# Assemble DEseq object
```{r}
ddsDrug <- DESeqDataSetFromMatrix(countMat, patAnno, design = ~1)
```

Annotate  genes
```{r}
geneAnno <- transcripts(EnsDb.Hsapiens.v86, columns = c("gene_id", "seq_name",
                                                        "gene_name","gene_biotype"), return.type = "DataFrame") %>% as_tibble() %>% distinct(gene_id, .keep_all = TRUE)

geneAnno$tx_id <- NULL

#annotate transcripts
rowAnno <- geneAnno %>% distinct(gene_id, seq_name, gene_name, gene_biotype) %>%
  dplyr::rename(chromosome = seq_name, symbol = gene_name, biotype = gene_biotype) %>%
  data.frame(stringsAsFactors = FALSE) %>% column_to_rownames("gene_id")


rowData(ddsDrug) <- rowAnno[rownames(ddsDrug),]
```

Post processing
```{r}
#remove genes never expressed
ddsDrug <- ddsDrug[rowSums(counts(ddsDrug)) !=0,]

#calculate size factor
ddsDrug <- estimateSizeFactors(ddsDrug)

#add sample ID
ddsDrug$ID <- colnames(ddsDrug)
```

# Summarise htseq statistics
```{r}
mappedTab <- tibble(id = colnames(countMat),
                   feature = "total mapped",
                   count=colSums(countMat))

totalTab <- bind_rows(ummapedTab, mappedTab) %>%
  group_by(id) %>% mutate(total = sum(count)) %>%
  ungroup() %>% mutate(percent = count/total) %>%
  mutate(fileName = fileTab[match(id, fileTab$id),]$fileName)


write_tsv(totalTab, file = "./htseq_summary.tsv")
```

# Save results
```{r}
save(ddsDrug,  file = "../../var/ddsDrug_htseq_20211011.RData")
```

